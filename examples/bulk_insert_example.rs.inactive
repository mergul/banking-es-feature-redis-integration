use banking_es::infrastructure::{
    event_store::{EventStore, EventStoreTrait},
    projections::ProjectionStore,
    write_batching::{PartitionedBatching, WriteOperation},
};
use rust_decimal::Decimal;
use std::sync::Arc;
use uuid::Uuid;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // Initialize event store and projection store
    let event_store = Arc::new(EventStore::new(
        sqlx::PgPool::connect("postgresql://user:pass@localhost/banking_es").await?,
    ));
    let projection_store = Arc::new(
        ProjectionStore::new(banking_es::infrastructure::projections::ProjectionConfig::default())
            .await?,
    );

    // Create write pool (simplified for example)
    let write_pool =
        Arc::new(sqlx::PgPool::connect("postgresql://user:pass@localhost/banking_es").await?);

    // Create outbox batcher
    let outbox_batcher = banking_es::infrastructure::cdc_debezium::OutboxBatcher::new_default(
        Arc::new(
            banking_es::infrastructure::cdc_debezium::CDCOutboxRepository::new(
                event_store.get_partitioned_pools().clone(),
            ),
        ),
        event_store.get_partitioned_pools().clone(),
    );

    // Initialize partitioned batching
    let batching = PartitionedBatching::new(
        event_store.clone(),
        projection_store.clone(),
        write_pool.clone(),
        outbox_batcher,
    )
    .await;

    println!("ğŸš€ Bulk insert sistemi baÅŸlatÄ±ldÄ±");

    // Ã–rnek 1: Bulk config ile hesap oluÅŸturma
    println!("\nğŸ“ Ã–rnek 1: Bulk config ile hesap oluÅŸturma");

    let accounts = vec![
        ("Ahmet YÄ±lmaz".to_string(), Decimal::new(1000, 0)),
        ("Fatma Demir".to_string(), Decimal::new(2500, 0)),
        ("Mehmet Kaya".to_string(), Decimal::new(500, 0)),
        ("AyÅŸe Ã–zkan".to_string(), Decimal::new(3000, 0)),
        ("Ali Ã‡elik".to_string(), Decimal::new(1500, 0)),
    ];

    // Bulk config ile hesap oluÅŸturma
    let account_ids = batching
        .submit_create_operations_batch_with_bulk_config(accounts)
        .await?;

    println!("âœ… {} hesap baÅŸarÄ±yla oluÅŸturuldu", account_ids.len());

    // Ã–rnek 2: Bulk config ile para yatÄ±rma iÅŸlemleri
    println!("\nğŸ’° Ã–rnek 2: Bulk config ile para yatÄ±rma iÅŸlemleri");

    let deposit_operations = account_ids
        .iter()
        .map(|account_id| {
            WriteOperation::DepositMoney {
                account_id: *account_id,
                amount: Decimal::new(100, 0), // 100 TL yatÄ±r
            }
        })
        .collect::<Vec<_>>();

    // Bulk config ile para yatÄ±rma
    let deposit_results = batching
        .submit_operations_with_bulk_config(deposit_operations)
        .await?;

    println!(
        "âœ… {} para yatÄ±rma iÅŸlemi baÅŸarÄ±yla tamamlandÄ±",
        deposit_results.len()
    );

    // Ã–rnek 3: Manuel bulk mod kontrolÃ¼
    println!("\nâš™ï¸ Ã–rnek 3: Manuel bulk mod kontrolÃ¼");

    // Bulk modu manuel olarak baÅŸlat
    batching.start_bulk_mode_all_partitions().await?;
    println!("ğŸ”„ Bulk mod aktif");

    // Ä°ÅŸlemleri yap
    let withdrawal_operations = account_ids
        .iter()
        .take(3) // Ä°lk 3 hesaptan para Ã§ek
        .map(|account_id| {
            WriteOperation::WithdrawMoney {
                account_id: *account_id,
                amount: Decimal::new(50, 0), // 50 TL Ã§ek
            }
        })
        .collect::<Vec<_>>();

    let withdrawal_results = batching
        .submit_operations_as_direct_batches(withdrawal_operations)
        .await?;

    println!(
        "âœ… {} para Ã§ekme iÅŸlemi tamamlandÄ±",
        withdrawal_results.len()
    );

    // Bulk modu manuel olarak sonlandÄ±r
    batching.end_bulk_mode_all_partitions().await?;
    println!("ğŸ”„ Bulk mod sonlandÄ±rÄ±ldÄ±");

    // Ã–rnek 4: BÃ¼yÃ¼k Ã¶lÃ§ekli bulk iÅŸlem
    println!("\nğŸ“Š Ã–rnek 4: BÃ¼yÃ¼k Ã¶lÃ§ekli bulk iÅŸlem");

    // 1000 hesap oluÅŸtur
    let large_accounts = (0..1000)
        .map(|i| {
            (
                format!("KullanÄ±cÄ±_{}", i),
                Decimal::new(1000 + (i as i64 * 10), 0),
            )
        })
        .collect::<Vec<_>>();

    println!("ğŸ”„ 1000 hesap oluÅŸturuluyor (bulk config ile)...");
    let start_time = std::time::Instant::now();

    let large_account_ids = batching
        .submit_create_operations_batch_with_bulk_config(large_accounts)
        .await?;

    let duration = start_time.elapsed();
    println!(
        "âœ… {} hesap {} saniyede oluÅŸturuldu (saniyede {:.0} hesap)",
        large_account_ids.len(),
        duration.as_secs_f64(),
        large_account_ids.len() as f64 / duration.as_secs_f64()
    );

    println!("\nğŸ‰ TÃ¼m bulk insert iÅŸlemleri baÅŸarÄ±yla tamamlandÄ±!");
    println!("ğŸ“ˆ Sistem performansÄ±:");
    println!("   - Event store batch size: 5000 (normal: 1000)");
    println!("   - Projection cache: devre dÄ±ÅŸÄ± (normal: aktif)");
    println!("   - Batch timeout: 50ms (normal: 100ms)");
    println!("   - Processor count: 16 (normal: 8)");

    Ok(())
}
