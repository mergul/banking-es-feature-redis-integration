use banking_es::infrastructure::{
    cdc_batching_service::{CDCBatchingConfig, PartitionedCDCBatching},
    projections::{AccountProjection, ProjectionConfig, ProjectionStore},
};
use chrono::Utc;
use rust_decimal::Decimal;
use std::sync::Arc;
use uuid::Uuid;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    println!("ğŸš€ CDC Batching Service Bulk Mode Ã–rnekleri");

    // 1. CDC Batching Service ile Bulk Mode
    println!("\nğŸ“ 1. CDC Batching Service ile Bulk Mode");

    // Projection store oluÅŸtur
    let config = ProjectionConfig::default();
    let projection_store = Arc::new(ProjectionStore::new(config).await?);

    // Write pool oluÅŸtur (sqlx import gerekli)
    let write_pool =
        Arc::new(sqlx::PgPool::connect("postgresql://user:pass@localhost/banking_es").await?);

    // CDC Batching Service oluÅŸtur
    let cdc_batching = PartitionedCDCBatching::new(projection_store, write_pool).await;

    // 1000 projection oluÅŸtur
    let mut projections = Vec::new();
    for i in 0..1000 {
        projections.push((
            Uuid::new_v4(), // aggregate_id
            AccountProjection {
                id: Uuid::new_v4(),
                owner_name: format!("KullanÄ±cÄ± {}", i),
                balance: Decimal::new(1000 + i as i64, 0),
                is_active: true,
                created_at: Utc::now(),
                updated_at: Utc::now(),
            },
        ));
    }

    let start_time = std::time::Instant::now();

    // Bulk mode ile projection'larÄ± gÃ¶nder
    let operation_ids = cdc_batching.submit_projections_bulk(projections).await?;

    let duration = start_time.elapsed();
    println!("âœ… 1000 projection bulk mode ile iÅŸlendi: {:?}", duration);
    println!("ğŸ“Š Operation ID'leri: {:?}", operation_ids.len());

    // 2. Manuel Bulk Mode KontrolÃ¼
    println!("\nğŸ“ 2. Manuel Bulk Mode KontrolÃ¼");

    // 500 projection daha oluÅŸtur
    let mut more_projections = Vec::new();
    for i in 1000..1500 {
        more_projections.push((
            Uuid::new_v4(),
            AccountProjection {
                id: Uuid::new_v4(),
                owner_name: format!("KullanÄ±cÄ± {}", i),
                balance: Decimal::new(2000 + i as i64, 0),
                is_active: true,
                created_at: Utc::now(),
                updated_at: Utc::now(),
            },
        ));
    }

    let start_time = std::time::Instant::now();

    // Manuel bulk mode ile gÃ¶nder
    let operation_ids = cdc_batching
        .submit_projections_bulk(more_projections)
        .await?;

    let duration = start_time.elapsed();
    println!(
        "âœ… 500 projection manuel bulk mode ile iÅŸlendi: {:?}",
        duration
    );

    // 3. Performance KarÅŸÄ±laÅŸtÄ±rmasÄ±
    println!("\nğŸ“ 3. Performance KarÅŸÄ±laÅŸtÄ±rmasÄ±");

    // Normal mode ile test
    let mut normal_projections = Vec::new();
    for i in 1500..1600 {
        normal_projections.push((
            Uuid::new_v4(),
            AccountProjection {
                id: Uuid::new_v4(),
                owner_name: format!("KullanÄ±cÄ± {}", i),
                balance: Decimal::new(3000 + i as i64, 0),
                is_active: true,
                created_at: Utc::now(),
                updated_at: Utc::now(),
            },
        ));
    }

    let start_time = std::time::Instant::now();
    let operation_ids = cdc_batching
        .submit_projections_bulk(normal_projections)
        .await?;
    let normal_duration = start_time.elapsed();

    println!("ğŸ“Š Performance KarÅŸÄ±laÅŸtÄ±rmasÄ±:");
    println!("   - Bulk Mode (1000 projection): {:?}", duration);
    println!("   - Normal Mode (100 projection): {:?}", normal_duration);
    println!(
        "   - Bulk Mode avantajÄ±: {}x daha hÄ±zlÄ±",
        normal_duration.as_millis() as f64 / (duration.as_millis() as f64 / 10.0)
    );

    println!("\nğŸ‰ CDC Batching Service Bulk Mode testi tamamlandÄ±!");
    Ok(())
}
